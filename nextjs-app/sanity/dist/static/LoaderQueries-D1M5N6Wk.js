import{g as K,r as p,aZ as X,K as H,ck as L,cl as Q,u as W,j as z,cm as Z,cn as J,b as tt}from"./sanity-CeuAV6R0.js";import{u as et,a as rt,b as it,m as nt}from"./utils-D6vawtMD.js";import{c as st,a as at,g as k}from"./PresentationToolGrantsCheck-BIEhXRWc.js";import"./DisplayedDocumentBroadcaster-g0KMFVaH.js";function R(r){if(typeof r!="function")throw new Error("obliterator/iterator: expecting a function!");this.next=r}typeof Symbol<"u"&&(R.prototype[Symbol.iterator]=function(){return this});R.of=function(){var r=arguments,t=r.length,e=0;return new R(function(){return e>=t?{done:!0}:{done:!1,value:r[e++]}})};R.empty=function(){var r=new R(function(){return{done:!0}});return r};R.fromSequence=function(r){var t=0,e=r.length;return new R(function(){return t>=e?{done:!0}:{done:!1,value:r[t++]}})};R.is=function(r){return r instanceof R?!0:typeof r=="object"&&r!==null&&typeof r.next=="function"};var ot=R,O={};O.ARRAY_BUFFER_SUPPORT=typeof ArrayBuffer<"u";O.SYMBOL_SUPPORT=typeof Symbol<"u";var $=O,ut=$.ARRAY_BUFFER_SUPPORT,ht=$.SYMBOL_SUPPORT,x=function(t,e){var n,i,s,h,u;if(!t)throw new Error("obliterator/forEach: invalid iterable.");if(typeof e!="function")throw new Error("obliterator/forEach: expecting a callback.");if(Array.isArray(t)||ut&&ArrayBuffer.isView(t)||typeof t=="string"||t.toString()==="[object Arguments]"){for(s=0,h=t.length;s<h;s++)e(t[s],s);return}if(typeof t.forEach=="function"){t.forEach(e);return}if(ht&&Symbol.iterator in t&&typeof t.next!="function"&&(t=t[Symbol.iterator]()),typeof t.next=="function"){for(n=t,s=0;u=n.next(),u.done!==!0;)e(u.value,s),s++;return}for(i in t)t.hasOwnProperty(i)&&e(t[i],i)},j={};(function(r){var t=Math.pow(2,8)-1,e=Math.pow(2,16)-1,n=Math.pow(2,32)-1,i=Math.pow(2,7)-1,s=Math.pow(2,15)-1,h=Math.pow(2,31)-1;r.getPointerArray=function(a){var o=a-1;if(o<=t)return Uint8Array;if(o<=e)return Uint16Array;if(o<=n)return Uint32Array;throw new Error("mnemonist: Pointer Array of size > 4294967295 is not supported.")},r.getSignedPointerArray=function(a){var o=a-1;return o<=i?Int8Array:o<=s?Int16Array:o<=h?Int32Array:Float64Array},r.getNumberType=function(a){return a===(a|0)?Math.sign(a)===-1?a<=127&&a>=-128?Int8Array:a<=32767&&a>=-32768?Int16Array:Int32Array:a<=255?Uint8Array:a<=65535?Uint16Array:Uint32Array:Float64Array};var u={Uint8Array:1,Int8Array:2,Uint16Array:3,Int16Array:4,Uint32Array:5,Int32Array:6,Float32Array:7,Float64Array:8};r.getMinimalRepresentation=function(a,o){var l=null,c=0,d,w,m,v,A;for(v=0,A=a.length;v<A;v++)m=o?o(a[v]):a[v],w=r.getNumberType(m),d=u[w.name],d>c&&(c=d,l=w);return l},r.isTypedArray=function(a){return typeof ArrayBuffer<"u"&&ArrayBuffer.isView(a)},r.concat=function(){var a=0,o,l,c;for(o=0,c=arguments.length;o<c;o++)a+=arguments[o].length;var d=new arguments[0].constructor(a);for(o=0,l=0;o<c;o++)d.set(arguments[o],l),l+=arguments[o].length;return d},r.indices=function(a){for(var o=r.getPointerArray(a),l=new o(a),c=0;c<a;c++)l[c]=c;return l}})(j);var U={},D=x,G=j;function ft(r){return Array.isArray(r)||G.isTypedArray(r)}function V(r){if(typeof r.length=="number")return r.length;if(typeof r.size=="number")return r.size}function ct(r){var t=V(r),e=typeof t=="number"?new Array(t):[],n=0;return D(r,function(i){e[n++]=i}),e}function lt(r){var t=V(r),e=typeof t=="number"?G.getPointerArray(t):Array,n=typeof t=="number"?new Array(t):[],i=typeof t=="number"?new e(t):[],s=0;return D(r,function(h){n[s]=h,i[s]=s++}),[n,i]}U.isArrayLike=ft;U.guessLength=V;U.toArray=ct;U.toArrayWithIndices=lt;var B=ot,dt=x,pt=j,yt=U;function y(r,t,e){if(arguments.length<2&&(e=r,r=null,t=null),this.capacity=e,typeof this.capacity!="number"||this.capacity<=0)throw new Error("mnemonist/lru-cache: capacity should be positive number.");if(!isFinite(this.capacity)||Math.floor(this.capacity)!==this.capacity)throw new Error("mnemonist/lru-cache: capacity should be a finite positive integer.");var n=pt.getPointerArray(e);this.forward=new n(e),this.backward=new n(e),this.K=typeof r=="function"?new r(e):new Array(e),this.V=typeof t=="function"?new t(e):new Array(e),this.size=0,this.head=0,this.tail=0,this.items={}}y.prototype.clear=function(){this.size=0,this.head=0,this.tail=0,this.items={}};y.prototype.splayOnTop=function(r){var t=this.head;if(this.head===r)return this;var e=this.backward[r],n=this.forward[r];return this.tail===r?this.tail=e:this.backward[n]=e,this.forward[e]=n,this.backward[t]=r,this.head=r,this.forward[r]=t,this};y.prototype.set=function(r,t){var e=this.items[r];if(typeof e<"u"){this.splayOnTop(e),this.V[e]=t;return}this.size<this.capacity?e=this.size++:(e=this.tail,this.tail=this.backward[e],delete this.items[this.K[e]]),this.items[r]=e,this.K[e]=r,this.V[e]=t,this.forward[e]=this.head,this.backward[this.head]=e,this.head=e};y.prototype.setpop=function(r,t){var e=null,n=null,i=this.items[r];return typeof i<"u"?(this.splayOnTop(i),e=this.V[i],this.V[i]=t,{evicted:!1,key:r,value:e}):(this.size<this.capacity?i=this.size++:(i=this.tail,this.tail=this.backward[i],e=this.V[i],n=this.K[i],delete this.items[n]),this.items[r]=i,this.K[i]=r,this.V[i]=t,this.forward[i]=this.head,this.backward[this.head]=i,this.head=i,n?{evicted:!0,key:n,value:e}:null)};y.prototype.has=function(r){return r in this.items};y.prototype.get=function(r){var t=this.items[r];if(!(typeof t>"u"))return this.splayOnTop(t),this.V[t]};y.prototype.peek=function(r){var t=this.items[r];if(!(typeof t>"u"))return this.V[t]};y.prototype.forEach=function(r,t){t=arguments.length>1?t:this;for(var e=0,n=this.size,i=this.head,s=this.K,h=this.V,u=this.forward;e<n;)r.call(t,h[i],s[i],this),i=u[i],e++};y.prototype.keys=function(){var r=0,t=this.size,e=this.head,n=this.K,i=this.forward;return new B(function(){if(r>=t)return{done:!0};var s=n[e];return r++,r<t&&(e=i[e]),{done:!1,value:s}})};y.prototype.values=function(){var r=0,t=this.size,e=this.head,n=this.V,i=this.forward;return new B(function(){if(r>=t)return{done:!0};var s=n[e];return r++,r<t&&(e=i[e]),{done:!1,value:s}})};y.prototype.entries=function(){var r=0,t=this.size,e=this.head,n=this.K,i=this.V,s=this.forward;return new B(function(){if(r>=t)return{done:!0};var h=n[e],u=i[e];return r++,r<t&&(e=s[e]),{done:!1,value:[h,u]}})};typeof Symbol<"u"&&(y.prototype[Symbol.iterator]=y.prototype.entries);y.prototype.inspect=function(){for(var r=new Map,t=this.entries(),e;e=t.next(),!e.done;)r.set(e.value[0],e.value[1]);return Object.defineProperty(r,"constructor",{value:y,enumerable:!1}),r};typeof Symbol<"u"&&(y.prototype[Symbol.for("nodejs.util.inspect.custom")]=y.prototype.inspect);y.from=function(r,t,e,n){if(arguments.length<2){if(n=yt.guessLength(r),typeof n!="number")throw new Error("mnemonist/lru-cache.from: could not guess iterable length. Please provide desired capacity as last argument.")}else arguments.length===2&&(n=t,t=null,e=null);var i=new y(t,e,n);return dt(r,function(s,h){i.set(h,s)}),i};var mt=y,C=mt,wt=x,vt=j,gt=U;function _(r,t,e){arguments.length<2?C.call(this,r):C.call(this,r,t,e);var n=vt.getPointerArray(this.capacity);this.deleted=new n(this.capacity),this.deletedSize=0}for(var F in C.prototype)_.prototype[F]=C.prototype[F];typeof Symbol<"u"&&(_.prototype[Symbol.iterator]=C.prototype[Symbol.iterator]);_.prototype.clear=function(){C.prototype.clear.call(this),this.deletedSize=0};_.prototype.set=function(r,t){var e=this.items[r];if(typeof e<"u"){this.splayOnTop(e),this.V[e]=t;return}this.size<this.capacity?(this.deletedSize>0?e=this.deleted[--this.deletedSize]:e=this.size,this.size++):(e=this.tail,this.tail=this.backward[e],delete this.items[this.K[e]]),this.items[r]=e,this.K[e]=r,this.V[e]=t,this.forward[e]=this.head,this.backward[this.head]=e,this.head=e};_.prototype.setpop=function(r,t){var e=null,n=null,i=this.items[r];return typeof i<"u"?(this.splayOnTop(i),e=this.V[i],this.V[i]=t,{evicted:!1,key:r,value:e}):(this.size<this.capacity?(this.deletedSize>0?i=this.deleted[--this.deletedSize]:i=this.size,this.size++):(i=this.tail,this.tail=this.backward[i],e=this.V[i],n=this.K[i],delete this.items[n]),this.items[r]=i,this.K[i]=r,this.V[i]=t,this.forward[i]=this.head,this.backward[this.head]=i,this.head=i,n?{evicted:!0,key:n,value:e}:null)};_.prototype.delete=function(r){var t=this.items[r];if(typeof t>"u")return!1;if(delete this.items[r],this.size===1)return this.size=0,this.head=0,this.tail=0,this.deletedSize=0,!0;var e=this.backward[t],n=this.forward[t];return this.head===t&&(this.head=n),this.tail===t&&(this.tail=e),this.forward[e]=n,this.backward[n]=e,this.size--,this.deleted[this.deletedSize++]=t,!0};_.prototype.remove=function(r,t=void 0){var e=this.items[r];if(typeof e>"u")return t;var n=this.V[e];if(delete this.items[r],this.size===1)return this.size=0,this.head=0,this.tail=0,this.deletedSize=0,n;var i=this.backward[e],s=this.forward[e];return this.head===e&&(this.head=s),this.tail===e&&(this.tail=i),this.forward[i]=s,this.backward[s]=i,this.size--,this.deleted[this.deletedSize++]=e,n};_.from=function(r,t,e,n){if(arguments.length<2){if(n=gt.guessLength(r),typeof n!="number")throw new Error("mnemonist/lru-cache.from: could not guess iterable length. Please provide desired capacity as last argument.")}else arguments.length===2&&(n=t,t=null,e=null);var i=new _(t,e,n);return wt(r,function(s,h){i.set(h,s)}),i};var At=_;const bt=K(At);function Ct(r){const{liveDocument:t,controller:e,perspective:n,documentsOnPage:i,onLoadersConnection:s,onDocumentsOnPage:h}=r,[u,a]=p.useState(),[o,l]=p.useState({}),c=X(),d=H();p.useEffect(()=>{const g=setInterval(()=>l(f=>{if(Object.keys(f).length<1)return f;const E=Date.now();if(!Object.values(f).some(P=>P.heartbeat!==!1&&E>P.receivedAt+P.heartbeat))return f;const I={};for(const[P,M]of Object.entries(f))M.heartbeat!==!1&&E>M.receivedAt+M.heartbeat||(I[P]=M);return I}),L);return()=>clearInterval(g)},[]),p.useEffect(()=>{if(e){const g=e.createChannel({name:"presentation",connectTo:"loaders",heartbeat:!0},st().provide({actors:at()}));return a(g),g.onStatus(s),g.on("loader/documents",f=>{f.projectId===c&&f.dataset===d&&h("loaders",f.perspective,f.documents)}),g.on("loader/query-listen",f=>{if(f.projectId===c&&f.dataset===d){if(typeof f.heartbeat=="number"&&f.heartbeat<L)throw new Error(`Loader query listen heartbeat interval must be at least ${L}ms`);l(E=>({...E,[_t(f.query,f.params)]:{perspective:f.perspective,query:f.query,params:f.params,receivedAt:Date.now(),heartbeat:f.heartbeat??!1}}))}}),g.start()}},[e,d,h,s,c]);const[w]=p.useState(()=>new bt(Q)),m=W({apiVersion:"2023-10-16"}),v=p.useMemo(()=>m.config(),[m]),A=p.useMemo(()=>m.withConfig({resultSourceMap:"withKeyArraySelector"}),[m]);p.useEffect(()=>{if(u){const{projectId:g,dataset:f}=v;u.post("loader/perspective",{projectId:g,dataset:f,perspective:n})}},[u,v,n]);const T=p.useMemo(()=>{const g=i.map(({_id:I})=>I),f=[...new Set(g)],E=w.capacity;return f.length>=E&&(f.length=E),f},[w.capacity,i]),[S,b]=p.useState(0);return z.jsxs(z.Fragment,{children:[z.jsx(It,{cache:w,client:A,turboIds:T,setDocumentsCacheLastUpdated:b}),Object.entries(o).map(([g,{query:f,params:E,perspective:I}])=>z.jsx(St,{cache:w,projectId:v.projectId,dataset:v.dataset,perspective:I,query:f,params:E,comlink:u,client:A,refreshInterval:n?2e3:0,liveDocument:t,documentsCacheLastUpdated:S},`${g}${I}`))]})}const It=p.memo(function(r){const{cache:t,client:e,turboIds:n,setDocumentsCacheLastUpdated:i}=r,[s,h]=p.useState([]);return p.useEffect(()=>{const u=new Set(s.flat()),a=new Set;for(const c of n)!u.has(c)&&!t.has(c)&&a.add(c);const o=[...a].slice(0,Z);if(o.length===0)return;const l=requestAnimationFrame(()=>h(c=>[...c.slice(-100),o]));return()=>cancelAnimationFrame(l)},[s,t,n]),p.useEffect(()=>{const u=e.listen("*",{},{events:["mutation"],effectFormat:"mendoza",includePreviousRevision:!1,includeResult:!1,tag:"presentation-loader"}).subscribe(a=>{var l,c;if(a.type==="mutation"&&a.transition==="disappear"&&t.delete(a.documentId)&&i(Date.now()),a.type!=="mutation"||!((c=(l=a.effects)==null?void 0:l.apply)!=null&&c.length))return;const o=t.peek(a.documentId);if(o){const d={...o};delete d._rev;const w=J(d,a.effects.apply);t.set(a.documentId,w),i(Date.now())}});return()=>u.unsubscribe()},[t,e,i]),z.jsx(z.Fragment,{children:s.map(u=>z.jsx(Y,{cache:t,client:e,ids:u,setDocumentsCacheLastUpdated:i},JSON.stringify(u)))})}),Y=p.memo(function(r){const{client:t,cache:e,ids:n,setDocumentsCacheLastUpdated:i}=r;return p.useEffect(()=>{const s=n.filter(h=>!e.has(h));s.length!==0&&t.getDocuments(s).then(h=>{for(const u of h)u&&(u!=null&&u._id)&&(e.set(u._id,u),i(Date.now()))},console.error)},[e,t,n,i]),null});Y.displayName="GetDocuments";function St(r){const t=tt.c(20),{cache:e,projectId:n,dataset:i,perspective:s,query:h,client:u,refreshInterval:a,liveDocument:o,comlink:l,documentsCacheLastUpdated:c}=r,d=et(r.params);let w;t[0]!==e||t[1]!==u||t[2]!==c||t[3]!==o||t[4]!==d||t[5]!==s||t[6]!==h||t[7]!==a?(w={cache:e,client:u,liveDocument:o,params:d,perspective:s,query:h,refreshInterval:a,documentsCacheLastUpdated:c},t[0]=e,t[1]=u,t[2]=c,t[3]=o,t[4]=d,t[5]=s,t[6]=h,t[7]=a,t[8]=w):w=t[8];const m=Et(w),v=m==null?void 0:m.result,A=m==null?void 0:m.resultSourceMap,T=m==null?void 0:m.tags;let S,b;return t[9]!==l||t[10]!==i||t[11]!==d||t[12]!==s||t[13]!==n||t[14]!==h||t[15]!==v||t[16]!==A||t[17]!==T?(S=()=>{A&&(l==null||l.post("loader/query-change",{projectId:n,dataset:i,perspective:s,query:h,params:d,result:v,resultSourceMap:A,tags:T}))},b=[l,i,d,s,n,h,v,A,T],t[9]=l,t[10]=i,t[11]=d,t[12]=s,t[13]=n,t[14]=h,t[15]=v,t[16]=A,t[17]=T,t[18]=S,t[19]=b):(S=t[18],b=t[19]),p.useEffect(S,b),null}function Et(r){const{cache:t,liveDocument:e,client:n,refreshInterval:i,query:s,params:h,perspective:u,documentsCacheLastUpdated:a}=r,[o,l]=p.useState(null),{projectId:c,dataset:d}=p.useMemo(()=>{const{projectId:S,dataset:b}=n.config();return{projectId:S,dataset:b}},[n]),[w,m]=p.useState(null);if(w)throw w;const[v,A]=rt({refreshInterval:i}),T=v==="refresh"||v==="inflight";return p.useEffect(()=>{if(!T)return;let S=!1,b=!1;const g=new AbortController;async function f(){const{signal:I}=g;b=!0;const{result:P,resultSourceMap:M,syncTags:q}=await n.fetch(s,h,{tag:"presentation-loader",signal:I,perspective:u,filterResponse:!1});b=!1,I.aborted||(l({result:P,resultSourceMap:M,tags:q}),S=!0)}const E=A();return f().catch(I=>{b=!1,I.name!=="AbortError"&&m(I)}).finally(E),()=>{!S&&!b&&g.abort()}},[n,d,e,h,u,c,s,T,A]),p.useMemo(()=>a&&(o!=null&&o.resultSourceMap)?{result:Rt(t,e,o.result,u,o.resultSourceMap),resultSourceMap:o.resultSourceMap}:o,[t,a,e,u,o])}let N=!1;function Rt(r,t,e,n,i){if(n==="raw")throw new Error("turboChargeResultIfSourceMap does not support raw perspective");return it(e,i,s=>{if(s._projectId){N||(console.warn("Cross dataset references are not supported yet, ignoring source document",s),N=!0);return}return t!=null&&t._id&&k(t._id)===k(s._id)?typeof t._id=="string"&&typeof s._type=="string"?t:{...t,_id:t._id||s._id,_type:t._type||s._type}:r.get(s._id)},nt,n)}function _t(r,t){return`${r}-${typeof t=="string"?t:JSON.stringify(t)}`}export{Ct as default,Rt as turboChargeResultIfSourceMap};
