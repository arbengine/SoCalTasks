import{r as l,aZ as K,K as F,ck as R,u as B,a_ as P,co as H,j as q,b as V}from"./sanity-CeuAV6R0.js";import{b as J,u as X,a as Y,m as Z}from"./utils-D6vawtMD.js";import{c as z,a as G,g as Q}from"./PresentationToolGrantsCheck-BIEhXRWc.js";import{i as x}from"./DisplayedDocumentBroadcaster-g0KMFVaH.js";function ne(n){const{liveDocument:e,controller:i,perspective:h,onLoadersConnection:a,onDocumentsOnPage:b}=n,[f,T]=l.useState(),[m,A]=l.useState({}),E=K(),M=F();l.useEffect(()=>{const s=setInterval(()=>A(t=>{if(Object.keys(t).length<1)return t;const y=Date.now();if(!Object.values(t).some(r=>r.heartbeat!==!1&&y>r.receivedAt+r.heartbeat))return t;const u={};for(const[r,g]of Object.entries(t))g.heartbeat!==!1&&y>g.receivedAt+g.heartbeat||(u[r]=g);return u}),R);return()=>clearInterval(s)},[]),l.useEffect(()=>{if(i){const s=i.createChannel({name:"presentation",connectTo:"loaders",heartbeat:!0},z().provide({actors:G()}));return T(s),s.onStatus(a),s.on("loader/documents",t=>{t.projectId===E&&t.dataset===M&&b("loaders",t.perspective,t.documents)}),s.on("loader/query-listen",t=>{if(t.projectId===E&&t.dataset===M){if(typeof t.heartbeat=="number"&&t.heartbeat<R)throw new Error(`Loader query listen heartbeat interval must be at least ${R}ms`);A(y=>({...y,[ee(t.query,t.params)]:{perspective:t.perspective,query:t.query,params:t.params,receivedAt:Date.now(),heartbeat:t.heartbeat??!1}}))}}),s.start()}},[i,M,b,a,E]);const[I]=l.useState(()=>new Set),[w,c]=l.useState(null),d=B({apiVersion:"2023-10-16"}),p=l.useMemo(()=>d.config(),[d]),S=l.useMemo(()=>d.withConfig({resultSourceMap:"withKeyArraySelector"}),[d]);l.useEffect(()=>{if(f){const{projectId:s,dataset:t}=p;f.post("loader/perspective",{projectId:s,dataset:t,perspective:h})}},[f,p,h]);const j=P(s=>{const t=Array.from(I).flat();s.tags.some(y=>t.includes(y))?c(s.id):console.log("No matching tags found",s.tags,{flattenedSyncTags:t})});l.useEffect(()=>{const s=H(S.config()).withConfig({apiVersion:"vX"}).live.events({includeDrafts:!0,tag:"presentation-loader"}).subscribe({next:t=>{t.type==="message"?j(t):t.type==="restart"?c(t.id):t.type==="reconnect"&&c(null)},error:t=>console.error("Error validating EventSource URL:",t)});return()=>s.unsubscribe()},[S,j]);const C=l.useDeferredValue(e);return q.jsx(q.Fragment,{children:Object.entries(m).map(([s,{query:t,params:y,perspective:u}])=>q.jsx(_,{projectId:p.projectId,dataset:p.dataset,perspective:u,query:t,params:y,comlink:f,client:S,liveDocument:C,lastLiveEventId:w,syncTagsInUse:I},`${s}${u}`))})}function W(n){const e=V.c(14),{projectId:i,dataset:h,perspective:a,query:b,client:f,liveDocument:T,comlink:m,lastLiveEventId:A,syncTagsInUse:E}=n,M=X(n.params),{result:I,resultSourceMap:w,syncTags:c}=D({client:f,liveDocument:T,params:M,perspective:a,query:b,lastLiveEventId:A})||{};let d;e[0]!==h||e[1]!==i?(d=(C,s,t,y,u,r,g)=>{C==null||C.post("loader/query-change",{projectId:i,dataset:h,perspective:s,query:t,params:y,result:u,resultSourceMap:r,tags:g})},e[0]=h,e[1]=i,e[2]=d):d=e[2];const p=P(d);let S,j;return e[3]!==m||e[4]!==p||e[5]!==M||e[6]!==a||e[7]!==b||e[8]!==I||e[9]!==w||e[10]!==E||e[11]!==c?(S=()=>{if(w&&p(m,a,b,M,I,w,c),Array.isArray(c))return E.add(c),()=>{E.delete(c)}},j=[m,p,M,a,b,I,w,E,c],e[3]=m,e[4]=p,e[5]=M,e[6]=a,e[7]=b,e[8]=I,e[9]=w,e[10]=E,e[11]=c,e[12]=S,e[13]=j):(S=e[12],j=e[13]),l.useEffect(S,j),null}const _=l.memo(W);_.displayName="Memo(QuerySubscription)";function D(n){const e=V.c(25),{liveDocument:i,client:h,query:a,params:b,perspective:f,lastLiveEventId:T}=n,[m,A]=l.useState(null),[E,M]=l.useState(null);if(E)throw E;let I;e[0]===Symbol.for("react.memo_cache_sentinel")?(I={refreshInterval:0},e[0]=I):I=e[0];const[w,c]=Y(I),d=w==="refresh"||w==="inflight"||T!==(m==null?void 0:m.lastLiveEventId);let p,S;e[1]!==h||e[2]!==T||e[3]!==b||e[4]!==f||e[5]!==a||e[6]!==d||e[7]!==c?(p=()=>{if(!d)return;let u;u=!1;let r;r=!1;const g=new AbortController,k=async function(){const{signal:L}=g;r=!0;const{result:O,resultSourceMap:$,syncTags:N}=await h.fetch(a,b,{lastLiveEventId:T,tag:"presentation-loader",signal:L,perspective:f,filterResponse:!1,returnQuery:!1});r=!1,L.aborted||(A(o=>({result:x(o==null?void 0:o.result,O)?o==null?void 0:o.result:O,resultSourceMap:x(o==null?void 0:o.resultSourceMap,$)?o==null?void 0:o.resultSourceMap:$,syncTags:x(o==null?void 0:o.syncTags,N)?o==null?void 0:o.syncTags:N,lastLiveEventId:T})),u=!0)},U=c();return k().catch(L=>{r=!1,L.name!=="AbortError"&&M(L)}).finally(U),()=>{!u&&!r&&g.abort()}},S=[h,T,b,f,a,d,c],e[1]=h,e[2]=T,e[3]=b,e[4]=f,e[5]=a,e[6]=d,e[7]=c,e[8]=p,e[9]=S):(p=e[8],S=e[9]),l.useEffect(p,S);let j;e[10]!==m?(j=m??{},e[10]=m,e[11]=j):j=e[11];const{result:C,resultSourceMap:s,syncTags:t}=j;let y;e:{if(i&&s){let r;e[12]!==i||e[13]!==f||e[14]!==s||e[15]!==C?(r=v(i,C,f,s),e[12]=i,e[13]=f,e[14]=s,e[15]=C,e[16]=r):r=e[16];let g;e[17]!==s||e[18]!==t||e[19]!==r?(g={result:r,resultSourceMap:s,syncTags:t},e[17]=s,e[18]=t,e[19]=r,e[20]=g):g=e[20],y=g;break e}let u;e[21]!==s||e[22]!==C||e[23]!==t?(u={result:C,resultSourceMap:s,syncTags:t},e[21]=s,e[22]=C,e[23]=t,e[24]=u):u=e[24],y=u}return y}function v(n,e,i,h){if(i==="raw")throw new Error("turboChargeResultIfSourceMap does not support raw perspective");return J(e,h,a=>!a._projectId&&(n!=null&&n._id)&&Q(n._id)===Q(a._id)?typeof n._id=="string"&&typeof a._type=="string"?n:{...n,_id:n._id||a._id,_type:n._type||a._type}:null,Z,i)}function ee(n,e){return`${n}-${typeof e=="string"?e:JSON.stringify(e)}`}export{ne as default,v as turboChargeResultIfSourceMap};
